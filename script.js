const timetableData = {
    "2025-2026 (Even)": {
        "Basic Sciences": [
            "B.Tech-ME_SectionB4", "B.Tech-BT+MCE-SectionA5", "B.Tech-CE-SectionA1",
            "B.Tech-TT-SectionA2", "B.Tech-IT-SectionA3", "B.Tech-EE+IT-SectionA4",
            "B.Tech-ICE-SectionA6", "SectionB3", "SectionB5", "B.Tech-CSE-SectionB1",
            "B.Tech-CSE+DS-SectionB2", "B.Tech-CH+VLSI-SectionB6", "Integrated-B.Sc-B.Ed-Sem2",
            "Integrated-B.Sc-B.Ed-Sem4", "Integrated-B.Sc-B.Ed-Sem6"
        ],
        "Biotechnology": [
    "B.Tech-BT-4",
    "B.Tech-BT-8",
    "B.Tech-BT-6",
    "M.Tech-BT-2"
],"Center for Artificial Intelligence" : [],
"Center for Energy and Environment":[],
"Chemical Engineering":[
    "B.Tech-CH-4",
    "B.Tech-CH-6",
    "B.Tech-CH-8",
    "M.Tech-CHE-2"
],"Chemistry":[
    "M.Sc-CHE-2",
    "M.Sc-CHE-4"
],"Civil Engineering":[
    "B.Tech-CE-4",
    "B.Tech-CE-6",
    "B.Tech-CE-8",
    "M.Tech-SCE-2",
    "M.Tech-GEID-2"
],"Computer Science and Engineering":[
    "B.Tech-CSE-4A",
    "B.Tech-CSE-4B",
    "B.Tech-CSE-6A",
    "B.Tech-CSE-6B",
    "B.Tech-CSE-8A",
    "B.Tech-CSE-8B",
    "M.Tech-CSE-2",
    "M.Tech-IS-2",
    "M.Tech-DSE-2"
],"Electrical Engineering":[
    "B.Tech-EE-4",
    "B.Tech-EE-6",
    "B.Tech-EE-8",
    "M.Tech-EVD-2"
],"Electronics and Communication Engineering":[
    "B.Tech-ECE-4",
    "B.Tech-ECE-6",
    "B.Tech-ECE-8",
    "M.Tech-SPML-2",
    "M.Tech-VL-2"
],"Humanities and Management":[

],"Industrial and Production Engineering":[
    "B.Tech-IPE-4",
    "B.Tech-IPE-6",
    "B.Tech-IPE-8",
    "M.Tech-IE-2",
    "Ph.D-IPE"
],"Information Technology":[

],"Instrumentation and Control Engineering":[
    "B.Tech-ICE-4",
    "B.Tech-ICE-6",
    "B.Tech-ICE-8",
    "M.Tech-MIA-2"
],"ITEP":[

],"Mathematics & Computing":[

],"Mechanical Engineering":[
    "B.Tech-ME-4A",
    "B.Tech-ME-4B",
    "B.Tech-ME-6A",
    "B.Tech-ME-6B",
    "B.Tech-ME-8",
    "M.Tech-DE-2",
    "M.Tech.-TEE-2"
],"Physics":[
],"Textile Technology":[]
    },
    "2025-2026 (Odd)": {
        "Basic Sciences": [
            "B.Tech-ME_SectionB4", "B.Tech-CSE+DS-SectionB2", "B.Tech-CH+VLSI-SectionB6",
            "B.Tech-CSE-SectionB1", "B.Tech-CE-SectionA1", "B.Tech-TT-SectionA2",
            "B.Tech-IT-SectionA3", "B.Tech-EE+IT-SectionA4", "B.Tech-BT+MCE-SectionA5",
            "B.Tech-ICE-SectionA6", "Integrated-B.Sc-B.Ed-2A", "Integrated-B.Sc-B.Ed-1A",
            "Integrated-B.Sc-B.Ed-Sem5", "SectionB5", "SectionB3"
        ],"Biotechnology": [
    "B.Tech-BT-3",
    "B.Tech-BT-5",
    "B.Tech-BT-7",
    "M.Tech-BT-1"
],"Center for Artificial Intelligence" : [
    "M.Tech-AI-1"
],"Center for Energy and Environment":[
    "M.Tech-RE-1"
],"Chemical Engineering":[
    "B.Tech-CH-3",
    "B.Tech-CH-5",
    "B.Tech-CH-7",
    "M.Tech-CHE-1"
],"Chemistry":[
    "M.Sc-CHE-3",
    "M.Sc-CHE-1",
    "Chemistry-OpenElective"
],"Civil Engineering":[
    "B.Tech-CE-3",
    "B.Tech-CE-5",
    "B.Tech-CE-7",
    "M.Tech-SCE-1",
    "M.Tech-GEID-1"
],"Computer Science and Engineering":[
    "B.Tech-CSE-3A",
    "B.Tech-CSE-3B",
    "B.Tech-CSE-5A",
    "B.Tech-CSE-5B",
    "B.Tech-CSE-7A",
    "B.Tech-CSE-7B",
    "M.Tech-IS-1",
    "M.Tech-DSE-1",
    "M.Tech-CSE-1"
],"Electrical Engineering":[
    "M.Tech-EVD-1",
    "B.Tech-EE-3",
    "B.Tech-EE-5",
    "B.Tech-EE-7"
],"Electronics and Communication Engineering":[
    "B.Tech-ECE-3A",
    "B.Tech-ECE-3B",
    "B.Tech-ECE-5",
    "B.Tech-ECE-7",
    "M.Tech-VL-1",
    "M.Tech-SPML-1"
],"Humanities and Management":[
    "MBA-1",
    "MBA-3",
    "HM-OpenElective",
    "HM-GenericElective-5"
],"Industrial and Production Engineering":[
    "B.Tech-IPE-5",
    "B.Tech-IPE-7",
    "B.Tech-IPE-3",
    "M.Tech-IE-3",
    "M.Tech-IE-1",
    "Ph.D-IPE"
],"Information Technology":["B.Tech-IT-3", "B.Tech-IT-5", "B.Tech-IT-7", "M.Tech-DA-1", "B.Tech-IT-7", "B.Tech-IT-7", "MinorDegree-IT"],
"Instrumentation and Control Engineering":["B.Tech-ICE-3", "B.Tech-ICE-5", "B.Tech-ICE-7", "M. Tech-MIA-1"]
,"ITEP":[],
"Mathematics & Computing":["M.Tech-MC-1", "M.Sc-MAT-3", "M.Sc-MAT-1", "MAT-OpenElective", "B.Tech-MC-2"],
"Mechanical Engineering":["B.Tech-ME-5A", "B.Tech-ME-5B", "B.Tech-ME-3A", "M.Tech-DE-1", "B.Tech-ME-3B", "B.Tech-ME-7A", "B.Tech-ME-7B", "M.Tech-DE-3", "M.TECH-TE-3"],
"Physics":["M.Sc-PHY-1", "M.Sc-PHY-3", "Physics-OpenElective"],
"Textile Technology":["M.Tech-TT-3", "B.Tech-TT-3", "B.Tech-TT-5", "B.Tech-TT-7", "M.Tech-TT-1"]

    },
    "2024-2025 (Even)": {
        "Basic Sciences": [
            "B.Tech-CE-SectionA1", "B.Tech-TT-SectionA2", "B.Tech-IT-SectionA3",
            "B.Tech-EE+IT-SectionA4", "B.Tech-BT+MCE-SectionA5", "B.Tech-ICE-SectionA6",
            "B.Tech-CSE-SectionB1", "B.Tech-CSE+DS-SectionB2", "B.Tech-IPE+ME_SectionB3",
            "B.Tech-ECE+VLSI-SectionB5", "B.Tech-CH+VLSI-SectionB6", "Integrated-B.Sc-B.Ed-Sem2",
            "B.Tech-ME-SectionB4", "Integrated-B.Sc-B.Ed-Sem4", "B.Tech-FE-2", "B.Tech-CB-2"
        ]
    },
    "2024-2025 (Odd)": {
        "Basic Sciences": [
            "B.Tech-ME_SectionB4", "B.Tech-IPE+ME_SectionB3", "B.Tech-CSE+DS-SectionB2",
            "B.Tech-ECE+VLSI-SectionB5", "B.Tech-CH+VLSI-SectionB6", "B.Tech-CSE-SectionB1",
            "B.Tech-CE-SectionA1", "B.Tech-TT-SectionA2", "B.Tech-IT-SectionA3",
            "B.Tech-EE+IT-SectionA4", "B.Tech-BT+MCE-SectionA5", "B.Tech-ICE-SectionA6",
            "Integrated-B.Sc-B.Ed-2A", "Integrated-B.Sc-B.Ed-1A"
        ]
    },
    "2023-2024 (Even)": {
        "Basic Sciences": [
            "B.Tech-ME_SectionB4", "B.Tech-IPE+ME_SectionB3", "B.Tech-CSE+DS-SectionB2",
            "B.Tech-ECE+VLSI-SectionB5", "B.Tech-CH+VLSI-SectionB6", "B.Tech-CSE-SectionB1",
            "B.Tech-CE-SectionA1", "B.Tech-TT-SectionA2", "B.Tech-IT-SectionA3",
            "B.Tech-EE+IT-SectionA4", "B.Tech-BT+MCE-SectionA5", "B.Tech-ICE-SectionA6",
            "Integrated-B.Sc-B.Ed-2A", "Integrated-B.Sc-B.Ed-1A"
        ]
    }
};

const sessionSelect = document.getElementById('session');
const deptSelect = document.getElementById('department');
const dynamicSelect = document.getElementById('dynamicOption');
const sendPdfBtn = document.getElementById('sendPdfBtn');
const remindBtn = document.getElementById('remindBtn');
const statusMsg = document.getElementById('statusMessage');
const instaInput = document.getElementById('instagram');

// REPLACE THIS with your generated Public Key
const VAPID_PUBLIC_KEY = "BJhmfs5UWViN9OV-MJQihF0CL77zLmyGdeSdJavkTuxbevNmQtHQphqgP9cbMwVvcGK90Ta2UG3hkn6URbnKyDw";

// Standard UI Logic
function checkInputs() {
    const isComplete = instaInput.value.trim() !== "" && sessionSelect.value !== "" && deptSelect.value !== "" && dynamicSelect.value !== "";
    sendPdfBtn.disabled = !isComplete;
    remindBtn.disabled = !isComplete;
}

function updateDynamicOptions() {
    const session = sessionSelect.value;
    const dept = deptSelect.value;
    dynamicSelect.innerHTML = '<option value="">Select Semester/Section</option>';
    if (timetableData[session] && timetableData[session][dept]) {
        timetableData[session][dept].forEach(item => {
            const opt = document.createElement('option');
            opt.value = item; opt.textContent = item;
            dynamicSelect.appendChild(opt);
        });
        dynamicSelect.disabled = false;
    } else { dynamicSelect.disabled = true; }
    checkInputs();
}

sessionSelect.addEventListener('change', updateDynamicOptions);
deptSelect.addEventListener('change', updateDynamicOptions);
dynamicSelect.addEventListener('change', checkInputs);
instaInput.addEventListener('input', checkInputs);

// --- NEW FUNCTIONALITY ---

// 1. Direct PDF Download
sendPdfBtn.onclick = async function() {
    const payload = {
        instagram: instaInput.value.trim(),
        session: sessionSelect.value,
        department: deptSelect.value,
        section: dynamicSelect.value
    };
    
    statusMsg.textContent = "Generating PDF... Please wait.";
    statusMsg.style.color = "#3182ce";
    this.disabled = true;

    try {
        const response = await fetch('http://127.0.0.1:5000/process-all', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        if (!response.ok) throw new Error("Server failed to generate PDF");

        // 1. Convert the server response into a file blob
        const blob = await response.blob();
        
        // 2. Create a hidden link in the browser memory
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        
        // 3. Set the filename and trigger the click
        a.download = `Timetable_${payload.instagram}.pdf`;
        document.body.appendChild(a);
        a.click();
        
        // 4. Cleanup
        window.URL.revokeObjectURL(url);
        a.remove();

        statusMsg.textContent = "Download Started!";
        statusMsg.style.color = "#38a169";
    } catch (err) {
        statusMsg.textContent = "Error: " + err.message;
        statusMsg.style.color = "#e53e3e";
    } finally {
        this.disabled = false;
    }
};

// 2. Browser Push Reminders
remindBtn.onclick = async function() {
    statusMsg.textContent = "Requesting permission...";
    statusMsg.style.color = "#805ad5";

    try {
        const permission = await Notification.requestPermission();
        if (permission !== 'granted') {
            statusMsg.textContent = "Permission denied for notifications.";
            return;
        }

        const registration = await navigator.serviceWorker.register('sw.js');
        const subscription = await registration.pushManager.subscribe({
            userVisibleOnly: true,
            applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC_KEY)
        });

        const payload = {
            instagram: instaInput.value.trim(),
            session: sessionSelect.value,
            department: deptSelect.value,
            section: dynamicSelect.value,
            subscription: subscription
        };

        const res = await fetch('http://127.0.0.1:5000/set-reminder', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        if (res.ok) {
            statusMsg.textContent = "Daily browser reminders set!";
            statusMsg.style.color = "#38a169";
        }
    } catch (e) {
        statusMsg.textContent = "Failed to set reminders.";
        statusMsg.style.color = "#e53e3e";
        console.error(e);
    }
};

// Helper for VAPID key conversion
function urlBase64ToUint8Array(base64String) {
    const padding = '='.repeat((4 - base64String.length % 4) % 4);
    const base64 = (base64String + padding).replace(/\-/g, '+').replace(/_/g, '/');
    const rawData = window.atob(base64);
    const outputArray = new Uint8Array(rawData.length);
    for (let i = 0; i < rawData.length; ++i) {
        outputArray[i] = rawData.charCodeAt(i);
    }
    return outputArray;
}